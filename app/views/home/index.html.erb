<%= render 'layouts/header' %>

<%= render 'layouts/carousel', issues: @issues %>

<main id="home" class="ting">

<%  # show current issue title on the site
    display_title = @current_issue.title.gsub("The College Hill Independent", "")
                                        .gsub("The Indy", "")
    display_date =  @current_issue.date.strftime('%b %d, %Y')
    # get the featured articles and the rest, if we're supposed to.
    # reject FTE, which should not be featured!
    fte = (@current_articles.select { |a| a.category == "FTE" })[0]
    featured = @current_articles.select { |a| a.featured }
    the_rest = @current_articles.reject { |a| a.featured or a.category == 'FTE' }

    # which articles are going in the two big boxes up top? we want
    # ones with images, subtitles, and excerpts that are featured.
    nice_featured_articles = featured.select{ |a|
        # has image
        # and has body text
        # and has subtitle
        (!a.first_image_url.blank? and
         !removetags(strip_tags(a.body)).gsub(/\s/, '').gsub(/&nbsp;/, '').blank? and
         !a.subtitle.blank?)
    }
    bad_featured_articles = featured.reject{ |a|
        # has image
        # and has body text
        # and has subtitle
        (!a.first_image_url.blank? and
         !removetags(strip_tags(a.body)).gsub(/\s/, '').gsub(/&nbsp;/, '').blank? and
         !a.subtitle.blank?)
    }
    # shuffle around to get better
    while nice_featured_articles.length < 2 do
        nice_featured_articles.push bad_featured_articles.pop
    end
    while bad_featured_articles.length < 3 do
        bad_featured_articles.push the_rest.pop
    end
    while bad_featured_articles.length > 3 do
        the_rest.push bad_featured_articles.pop
    end
%>
    <div id="current-issue">
        <h2 style="float:left;"><%= display_title %></h2>
        <h2 style="float:right;"><%= display_date %></h2>
        <div class="clearfix"></div>
        <%# FTE box %>
        <div id="fte" class="caret">
            <h3>From the Editors</h3>
            <%= fte.body.html_safe %>
            <span>&ndash; <%= fte.by.upcase %></span>
            <div class="clearfix"></div>
        </div>

        <div id="top-feat">
        <% nice_featured_articles.each do |a| %>
            <div id="top-feat-article">
                <br>
                <%  if a.first_image_url.blank? 
                        bg = ""
                    else
                        bg = "style=\"background-image: url(#{a.first_image_url});\""
                    end
                %>
                <div class="img-holder" <%= bg.html_safe %>>
                </div>
                <p class="meta"><%= a.category %></p>
                <h3><%= a.title %></h3>
                <% unless a.subtitle.blank? %>
                    <h4><%= a.subtitle %></h4>
                <% end %>
                <p class="meta">by <%= link_to a.by, "/author?n=#{a.by.html_safe}" %></p>
                <% excerpt = strip_tags(a.body).gsub("&nbsp;", "").strip.split(/\s+/)[0..20].join(' ') %>
                <p class="excerpt"><%= excerpt %> &hellip;</p>
            </div>
        <% end %>
        <div class="clearfix"></div>
        </div>

        <div id="low-feat">
        <% bad_featured_articles.each do |a| %>
            <div id="low-feat-article">
                <br>
                <h3><%= a.title %></h3>
                <% unless a.subtitle.blank? %>
                    <h4><%= a.subtitle %></h4>
                <% end %>
                <p class="meta">by <%= link_to a.by, "/author?n=#{a.by.html_safe}" %></p>
            </div>
        <% end %>
        </div>
        <%= link_to "/toc/#{@current_issue.id}" do %>
        <h2>
        <% end %>
    </div>


    <h2>From the Archive</h2>

    <% (the_rest + @feed_articles).each do |a| %>
        <p><%= a.inspect() %></p>
    <% end %>
</main>